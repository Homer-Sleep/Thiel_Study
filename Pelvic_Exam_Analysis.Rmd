---
title: "Pelvic_Exam_Analysis"
output: pdf_document
---
```{r, echo=FALSE, message=FALSE}
library(plyr)
# library(papeR)
library(dplyr)
library(ggplot2)
library(knitr)
library(kableExtra)
library(tidyr)
library(data.table)
# library(foreign)
# library(multcomp)
# library(broom)
 library(nlme)
library(tidyverse)
# library(stargazer)
# library(reshape2)
# library(rmarkdown)
library(psych)
# library(RColorBrewer)
# library(minpack.lm)
# library(numDeriv)
# # library(mosaic)
# library(pracma)
# library(formattable)
# library(lme4)
# library(sjPlot)
# library(lsmeans)
library(factoextra)



options(scipen = 9999) # suppress scientific notation

plot_finish = theme_classic()+
  theme(plot.title = element_text(color= 'black',face='bold',size=18))+
   theme(axis.title.x = element_text(color= 'black',face='bold',size=18),
        axis.text.x = element_text(color= 'black',face='bold',size=18))+
  theme(axis.title.y = element_text(color= 'black',face='bold',size=18),
        axis.text.y = element_text(color= 'black',face='bold',size=18))+
 theme(legend.text = element_text( size = 18, face = "bold"))+
theme(legend.position="none")+
    theme(# adjust X-axis labels; also adjust their position using margin (acts like a bounding box)
          # using margin was needed because of the inwards placement of ticks
          # http://stackoverflow.com/questions/26367296/how-do-i-make-my-axis-ticks-face-inwards-in-ggplot2
          axis.text.x = element_text( margin = unit(c(t = 2.5, r = 0, b = 0, l = 0), "mm")),
          # adjust Y-axis labels
          axis.text.y = element_text( margin = unit(c(t = 0, r = 2.5, b = 0, l = 0), "mm")),
          # length of tick marks - negative sign places ticks inwards
          axis.ticks.length = unit(-1.4, "mm"),
          # width of tick marks in mm
          axis.ticks = element_line(size = .8))

```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```
1. I have previous experience performing female pelvic exams on live patients



### Anaysis Ideas
Look at Pre and post, Pre (3, 4) Post (9)

#9 I feel more confident performing a PE on a live patient - Seems to be the most important outcome. Regress to find predicting variables? 

group by which type of training (Thiel or task trainer) preferred, look for group differences, PCA within each group

### to do

```{r}
#import csv saved from raw data sheet in xlsx file of same name
Survey.dt = fread("Thiel cadaver pelvic exam Survey Analysis.csv")
Survey.dt = Survey.dt[complete.cases(Survey.dt),] # removed last row of NA's
# New names to reflect questions
new_colnames = c('ID', 'Q1_Exp.Live.Patient', 'Q2_Exp.Simulation', 'Q3_Pre.Feel.Prepared', 'Q4_Pre.Confidence',
                 'Q5_Simulation.Requirement', 'Q6_Simulation.Con.Requirement', 'Q7_Learned.PE', 'Q8_Skills.Retained.Utlized',
                 'Q9_Post.More.Confident', 'Q10_Thiel.Realism', 'Q11_Task.Trainer.Realism', 'Q12_Type.Gained.Knowledge', 
                 'Q13_Type.Feel.Prepared', 'Q14_Type.Feel.Confident')
setnames(Survey.dt, new_colnames)
summary(Survey.dt)
# Set 0's to NA's
Zeros = Survey.dt == 0
Survey.dt[Zeros] = NA
```

## Pre and Post differences

```{r}
# Confidence data.table
Confidence.dt = data.table(Group = c(rep('Pre', nrow(Survey.dt)), rep('Post', nrow(Survey.dt))), 
                           Score = c(Survey.dt$Q4_Pre.Confidence, Survey.dt$Q9_Post.More.Confident))
Confidence.dt$Group = factor(Confidence.dt$Group, levels = c('Pre', 'Post'))
# Means
  means = data.table(aggregate(Score ~ Group, Confidence.dt, mean))
  # change order
  means = means[c(2,1)]
  means$Score = round(means$Score, digits = 2)

#t.test
Results = t.test(Confidence.dt[Group == 'Pre']$Score, Confidence.dt[Group == 'Post']$Score, paired = TRUE)
#view results
Results


#plot with results:
p = ggplot(Confidence.dt, aes(x=Group, y=Score,  fill = Group)) +
    geom_boxplot() +
      scale_fill_manual(values = c('navyblue', 'gold'))+
    labs(title = paste('Confident Performing Pelvic Exam - Pre and Post'))+ 
    annotate('text', x = 1, y = -.05,  fontface = 'bold', label = means[Group == 'Pre']$Score)+
    annotate('text', x = 2, y = -.05,  fontface = 'bold', label = means[Group == 'Post']$Score)+
    annotate('text', x = 1.5, y = -.05,  fontface = 'bold', label = print('* p < 0.001'))
    
p = p + ylab('Disagree       --        Agree')
p = p + plot_finish
p
```

## Pre and Post differences Grouped by type of training preferred 

```{r}
# Confidence data.table
Type.dt = data.table(Group = c(rep('Pre', nrow(Survey.dt)), rep('Post', nrow(Survey.dt))), 
                           Score = c(Survey.dt$Q4_Pre.Confidence, Survey.dt$Q9_Post.More.Confident), 
                           Type = as.character(rep(Survey.dt$Q14_Type.Feel.Confident, 2)))
# remove NAs
Type.dt = Type.dt[complete.cases(Type.dt),]

Type.dt$Group = factor(Type.dt$Group, levels = c('Pre', 'Post'))
type.change = Type.dt$Type == '1'
Type.dt[type.change,]$Type = 'Thiel'
type.change = Type.dt$Type == '2'
Type.dt[type.change,]$Type = 'TT'
type.change = Type.dt$Type == '3'
Type.dt[type.change,]$Type = 'Neither'
Type.dt$Type = factor(Type.dt$Type, levels = c('Thiel', 'TT', 'Neither'))
#merge group and type to make one group col.
Type.dt$Group_Type = with(Type.dt, interaction(Group, Type))

# Means
  means = data.table(aggregate(Score ~ Group_Type , Type.dt, mean))
  means$Score = round(means$Score, digits = 2)
# n of each group
  means$N = aggregate(Score ~ Group_Type, Type.dt, length)$Score

#t.test
Thiel.Results = t.test(Type.dt[Group == 'Pre' & Type == 'Thiel']$Score, Type.dt[Group == 'Post' & Type == 'Thiel']$Score, paired = TRUE)
#view results
Thiel.Results

TT.Results = t.test(Type.dt[Group == 'Pre' & Type == 'TT']$Score, Type.dt[Group == 'Post' & Type == 'TT']$Score, paired = TRUE)
#view results
TT.Results 

#plot with results:
p = ggplot(Type.dt[Type != 'Neither'], aes(x=Group_Type, y=Score,  fill = Group_Type)) +
    geom_boxplot() +
      scale_fill_manual(values = rep(c('navyblue', 'gold'),2))+
    labs(title = paste('Confident Performing Pelvic Exam by Prefered Method'))+ 
    annotate('text', x = 1, y = -.05,  fontface = 'bold', label = means[Group_Type == 'Pre.Thiel']$Score)+
    annotate('text', x = 2, y = -.05,  fontface = 'bold', label = means[Group_Type == 'Post.Thiel']$Score)+
    annotate('text', x = 1.5, y = .05,  fontface = 'bold', label = print('p < 0.001*\nn = 64'))+

    annotate('text', x = 3, y = -.05,  fontface = 'bold', label = means[Group_Type == 'Pre.TT']$Score)+
    annotate('text', x = 4, y = -.05,  fontface = 'bold', label = means[Group_Type == 'Post.TT']$Score)+
    annotate('text', x = 3.5, y = .05,  fontface = 'bold', label = print('p = 0.1\nn = 4'))
    
p = p + ylab('Disagree     --     Agree')+ xlab('')
p = p + plot_finish
p
```

### PCA of variables
```{r}
################### Consider making a difference measure of confidence post - pre, 4 and 9, or just 9 considering the wording. 
Survey.dt = Survey.dt[complete.cases(Survey.dt),]
# summary(Survey.dt)
#remove excess text from col names to clean up PCA biplot:
Survey.dt.Num = Survey.dt
# colnames(Survey.dt.Num)
new_colnames = c('ID', 'Q1', 'Q2', 'Q3', 'Q4',
                 'Q5', 'Q6', 'Q7', 'Q8',
                 'Q9', 'Q10', 'Q11', 'Q12', 
                 'Q13', 'Q14')
setnames(Survey.dt.Num, new_colnames)


Results = prcomp(Survey.dt.Num[-c(1,62),-1], center = TRUE, scale = TRUE) # removed 1 and 62 as did not prefer a type
Results$rotation = -1 * Results$rotation
Results$x = -1 * Results$x
summary(Results)
p = fviz_pca_biplot(Results, repel=TRUE,  pointshape=21, col.var="red", arrowsize=0.6, labelsize=5)
p
```

Principal Component Analysis:
This approach looks at different components that explain the variance in the data. The first component explains the most amount of variance by spreading the data across a single line, x-axis, with the second component (2nd most amount of variance) on the y-axis. We see that the first component (PC1) explains 25% of the variance and PC2 explains 13%. 

Interpretation: 
These questions are grouped together: 

At seven o'clock, negative for PC1 and PC2
12 - I gained more knowledge about female pelvic exams using (thiel, TT, neither)
13 - I feel most prepared to perform a female pelvic exam after practicing on 
14 - I feel most confident to perform a female pelvic exam after practicing on

These questions are grouped together as they show preference, mostly for the thiel surgical donor

At five o'clock, positive for PC1 and negative for PC2
1 - I have previous experience of pelvic exam on live patient
3 - felt prepared to perform the female pelvic exam required in the upcoming third-year rotations, prior to the Doctoring I course session
4 - I felt confident performing a female pelvic exam prior to participating in this Doctoring I course session.
and some extent 2 - I have previous experience performing simulated female pelvic exams (thiel or TT). 
Shows that previous experience with a live patient was grouped with being prepared and having confidence. 







### Regress on Post Confidence
See what variables predict post confidence

```{r}

Confidence.lm = lme(Q9_Post.More.Confident ~ Q1_Exp.Live.Patient+ Q2_Exp.Simulation+ Q3_Pre.Feel.Prepared+ Q4_Pre.Confidence+ 
                      Q5_Simulation.Requirement+ Q6_Simulation.Con.Requirement + Q7_Learned.PE + Q8_Skills.Retained.Utlized +
                      Q10_Thiel.Realism + Q11_Task.Trainer.Realism + Q12_Type.Gained.Knowledge + Q13_Type.Feel.Prepared + 
                      Q14_Type.Feel.Confident, random =~ 1|ID, data = Survey.dt[complete.cases(Survey.dt)])
# make table output:
tTable = summary(Confidence.lm)[['tTable']] # retrieve tTable from linear model lme()

  print(kable(tTable, format = "html", escape = F)%>% # , caption = paste0('<b>',Modelname,'<b>')
  kable_styling( full_width = F)%>%
  column_spec(1,color="black", bold=T)%>%
  row_spec(0:nrow(tTable),color = "black"))
```

